# О zram

Сегодня всё больше дистрибутивов GNU/Linux включают уже настроенный zram. Среди
них Fedora, Calculate и прочие.

Говоря простыми словами, zram - это модуль ядра Linux, который создаёт RAM-диск
со сжатием данных "на лету", имеющий имя вроде `/dev/zram<id>`, где `<id>` - это
номер устройства. В нашем случае такой RAM-диск используется для
подкачки. И тут у пользователя возникает следующий
вопрос: *"А для чего это всё нужно, если я в качестве подкачки могу использовать
специально отведённый для этого раздел или файл?"*. Дело в том, что скорость
обмена с ОЗУ выше, чем с жёстким диском, поэтому если у пользователя активно
используется подкачка, то её нахождение в ОЗУ слегка может увеличить скорость
доступа к этим файлам. Кроме того, сегодня у многих пользователей GNU/Linux и
прочих UNIX-систем SSD-накопители, у которых цикл чтения/записи несколько
ограничен, и они либо боятся использовать на SSD подкачку, либо ещё по каким-то
причинам не хотят использовать её на SSD.

zRam использует алгоритм сжатия LZO или LZ4. Сжатие, в теории, может обеспечить
экономию памяти (а как на практике - пробуйте сами :)). Для получения более
подробной информации выполните:

```bash
# Просмотр поддерживаемых алгоритмов сжатия
cat /sys/block/zram0/comp_algorithm
# Выбор алгоритма сжатия 'lzo'
echo "lzo" > /sys/block/zram0/comp_algorithm
```

![](images/zram1.png)

В настоящее время содержимое `/sys/block/zram0/comp_algorithm` не обязательно
показывает список *всех* поддерживаемых ядром алгоритмов сжатия. Разработчики
сохраняют этот список в первую очередь для упрощения настройки устройства, а
также можно настроить новое устройство с алгоритмом сжатия, которого нет в
списке. zram использует Crypto API и, если некоторые алгоритмы были собраны как
модули (зависит от того, как собирали ядро Linux), невозможно перечислить их
все, используя, например, `/proc/crypto` или другие методы. Однако, есть и
преимущество, заключающееся в том, что позволяется использовать пользовательские
модули crypto compression (реализующее сжатие S/W или H/W).

## Начало работы

Существует несколько способов настройки и управления устройствами zRam:

1. Использование атрибутов `sysfs`: `zram` и `zram_control`;
2. Использование утилиты `zram`, которая находится в пакете `util-linux`

> **Смотрите также:**

> Чтобы получить более обширное и подробное представление о zRam и, в частности,
> `zramctl`, обратитесь к справочной документации пакета `util-linux` и
> справочной странице `zramctl`, а также короткой справке (`zramctl --help`).

> **Смотрите также (2):**

> Если вы пользователь Alt GNU/Linux, то у вас есть средство для настройки этого
> дистрибутива GNU/Linux - Alterator (Центр управления системой). Модуль
> называется *"Настройка `zram-swap`"*:
> ![](https://www.altlinux.org/Images.www.altlinux.org/3/3c/Alterator-zram-swap.png)

> **ВНИМАНИЕ!**

> Вся информация здесь на основе собственных знаний и документации, находящейся
> в открытом доступе, в том числе, документации из
> [kernel.org](https://www.kernel.org/doc/Documentation/blockdev), справочных
> страниц man и пр. (полный список в пункте "Литература". Для простоты здесь
> была пропущена часть проверок ошибок в приведённых ниже примеров. Используйте
> приведённые ниже примеры с умом и проверяйте каждую команду на корректность
> для дистрибутива GNU/Linux, который вы используете. Вы несёте исключительную
> ответственность за обработку ошибок. Однако, если в этой статье вы нашли
> ошибку, то обратитесь
> [сюда](https://github.com/Linuxoid85/LinuxSovet/issues/new) для составления
> отчёта об ошибке.

## "Универсальная" инструкция

Атрибуты `zram` sysfs всегда возвращают отрицательные значения в случае ошибок:

- `-EBUSY` - попытка изменения атрибута, который не может быть изменён после
  инициализации устройства. Сначала перезагрузите это устройство;
- `-ENOMEM` - zram не смог выделить достаточно памяти под ваши нужды;
- `-EINVAL` - неправильный ввод (некорректное значение, судя по всему).

Для начала требуется загрузить соответствующий модуль ядра, если он не загружен.
Такие дистрибутивы, как Ubuntu и прочие предоставляют пакет `zram-config`, а в
Fedora и Calculate, повторюсь, zRam активирован по умолчанию.

Выполните:

```bash
modprobe zram num_devices=4
```

Опция `num_devices` указывает количество сжатых блочных устройств, которое будет
создано. Для наиболее оптимального использования CPU следует учесть, что сжатие
каждого устройства zRam однопоточное, поэтому создавайте устройства по
количеству ядер процессора. У меня их четыре, столько же и сжатых блочных
устройств я создаю. В итоге, в моём случае, будет создано 4 блочных устройства:
`/dev/zram{0,1,2,3}`.

Обращаю ваше внимание на то, что параметр `num_devices` необязателен. Он
сообщает zram, сколько устройств должно быть создано. Если вы не укажете этот
параметр, то будет создано одно устройство, так как значение по умолчанию - 1.

Теперь требуется установить размер диска. Значение может быть либо в байтах,
либо в других единицах, тогда требуется использовать суффиксы `mem` (K, M, G,
др.).

Например:

```bash
# Инициализировать '/dev/zram0' с объёмом (размером диска - disksize) 100 Мб
echo $((100*1024*1024)) > /sys/block/zram0/disksize

# Использование суффиксов mem
echo 256K > /sys/block/zram0/disksize
echo 512M > /sys/block/zram0/disksize
echo 1G   > /sys/block/zram0/disksize

# Те же самые действия произведите и с другими устройствами, если их больше
# одного (zram{0,1,2,3} в моём случае)
```

При настройке модуля задаётся фиксированный размер **НЕ** сжатых данных в
байтах.

> **ВНИМАНИЕ!**

> Особого смысла создавать zram с объёмом памяти более чем в два раза б*о*льшим
> нет, так как ожидается степень сжатия 2:1. Обращаю ваше внимание на то, что
> zram использует около 0.1% от размера диска, когда он не используется, поэтому
> огромный размер zram является расточительством.

В конечном итоге будет создано устройство `/dev/zram0` заданного размера -
замените значение "100" из переменной `$SIZE` на необходимое вам. В большинстве
распространённых дистрибутивов GNU/Linux уже настроен zRam, но, как правило,
объём блочных устр-в равен половине объёма ОЗУ, что в некоторых случаях может
быть либо избыточным, либо недостаточным. В любом из случаев трезво оценивайте
нужный объём блочных устройств исходя из собственных потребностей.

Данные, записанные в полученное устройство, будут прозрачно сжаты в памяти. Что
с устройством делать - дело ваше. "Классический" вариант: создание разделов
подкачки:

```bash
mkswap /dev/zram0
```

И активирую его:

```bash
swapon /dev/zram0 -p 10
```

> Те же самые действия по созданию разделов подкачки и их активации произведите
> и с другими устройствами zram (у меня это, повторюсь, четыре устройства:
> `/dev/zram{0,1,2,3}`).

Для того, чтобы проверить результат, выполните:

```bash
swapon -s
```

Далее уже ядро само рассчитывает, какие данные туде перемещать в зависимости от
того, как часто вы к ним обращаетесь и как много памяти свободно. В любом случае
для регулирования отправления данных в swap, настройте `vm.swappiness`. К
примеру:

```bash
sysctl vm.swappiness=X
```

Либо же:

```bash
vim /etc/sysctl.conf
```

```
vm.swappiness=X
```

Где `X` - нужное вам целочисленное значение, которое может иметь значение от 0
до 100 (по умолчанию - 60). Низкое значение заставляет ядро избегать
использования подкачки, а более высокое значение - наоборот - позволяет
использовать подкачку активнее.

> **Смотрите также:**

> Настройка подкачки не является темой данной статьи. Если вы заинтересовались
> её настройкой, то посетите следующие сайты и прочитайте следующие статьи:
> - [Выбор размера файла подкачки](https://lx4u.ru/dev/additional/swap/) - LX4U
> - [Об ОЗУ и подкачке. LFS.](ram.md) - LinuxSovet

## Возможные недостатки использования zram как раздела подкачки

При наличии в системе нескольких swap-разделов, zram-устройство(а) будут иметь
более высокий приоритет, поэтому все выгружаемые страницы попадут, в первую
очередь, в zram-устройство(а). При переполнении этого раздела вновь выгружаемые
страницы будут попадать в следующие, более медленные, swap-разделы, в результате
чего появляется высокая вероятность возникновения LRU-инверсии
([тык](https://together.jolla.com/question/75162/replacing-zram-with-zswap/)).

В итоге, советуется использовать zram только в том случае, если в системе
отсутствуют swap'ы других типов (раздел на жёстком диске или SSD или файл
подкачки, например).

## Литература

- [Настройка zram](https://lx4u.ru/dev/additional/zram/) - LX4U Dev;
- [zram: Compressed RAM based block
  devices](https://www.kernel.org/doc/Documentation/blockdev/zram.txt) -
  kernel.org
- [Alterator-zram-swap](https://www.altlinux.org/Alterator-zram-swap)
- `man zramctl`

## Резюмируя

Так как с помощью zram подкачка находится в ОЗУ, т.е. данные в нём попросту
сжимаются, то такая подкачка может быть быстрее обычного файла/раздела подкачки
(возвращаемся к началу статьи). Используйте zram и прочие подобные инструменты
в случае необходимости, а также тогда, когда знаете, что делать.
